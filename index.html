<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Arquivos DAT</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #drop-zone { border: 2px dashed #007bff; padding: 20px; text-align: center; cursor: pointer; }
        #editor { width: 100%; height: 200px; margin-top: 10px; }
        .hidden { display: none; }
        #error-msg { color: red; }
    </style>
</head>
<body>

    <h2>Editor de Arquivos DAT ver.2</h2>

    <div id="drop-zone">Arraste um arquivo aqui ou <button onclick="document.getElementById('file-input').click()">Selecione um arquivo</button></div>
    <input type="file" id="file-input" class="hidden">
    
    <p id="error-msg" class="hidden">Erro ao carregar o arquivo!</p>

    <textarea id="editor" class="hidden"></textarea>

    <button id="download-decoded" class="hidden">Baixar como Texto</button>
    <button id="download-encoded" class="hidden">Baixar como DAT</button>

    <script>
        const fileInput = document.getElementById("file-input");
        const dropZone = document.getElementById("drop-zone");
        const editor = document.getElementById("editor");
        const downloadDecoded = document.getElementById("download-decoded");
        const downloadEncoded = document.getElementById("download-encoded");
        const errorMsg = document.getElementById("error-msg");

        let fileName = "";
        let binaryData = null;

        function arrayBufferToBase64(buffer) {
            let binary = '';
            let bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            let binary = atob(base64);
            let buffer = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                buffer[i] = binary.charCodeAt(i);
            }
            return buffer;
        }

        function handleFile(file) {
            if (!file) return;

            fileName = file.name;
            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const result = event.target.result;
                    binaryData = new Uint8Array(result); // Guardar os dados binários

                    const base64String = arrayBufferToBase64(result);
                    editor.value = base64String; // Exibir em Base64 para edição

                    editor.classList.remove("hidden");
                    downloadDecoded.classList.remove("hidden");
                    downloadEncoded.classList.remove("hidden");
                    errorMsg.classList.add("hidden");
                } catch (error) {
                    console.error("Erro ao processar o arquivo:", error);
                    errorMsg.classList.remove("hidden");
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function downloadFile(content, name, type) {
            const blob = new Blob([content], { type });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
        }

        dropZone.addEventListener("dragover", (event) => {
            event.preventDefault();
            dropZone.style.backgroundColor = "#f0f8ff";
        });

        dropZone.addEventListener("dragleave", () => {
            dropZone.style.backgroundColor = "transparent";
        });

        dropZone.addEventListener("drop", (event) => {
            event.preventDefault();
            dropZone.style.backgroundColor = "transparent";
            if (event.dataTransfer.files.length > 0) {
                handleFile(event.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener("change", () => {
            if (fileInput.files.length > 0) {
                handleFile(fileInput.files[0]);
            }
        });

        downloadDecoded.addEventListener("click", () => {
            downloadFile(editor.value, "plain.txt", "text/plain");
        });

        downloadEncoded.addEventListener("click", () => {
            const encodedBuffer = base64ToArrayBuffer(editor.value);
            downloadFile(encodedBuffer, "user1.dat", "application/octet-stream");
        });
    </script>

</body>
</html>
